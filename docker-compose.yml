services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: ecommerce-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DATABASE_PASSWORD}
      MYSQL_DATABASE: ${DATABASE_DB}
    ports:
      - "3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - ecommerce-network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: ecommerce-redis
    restart: always
    ports:
      - "6380:6379"
    networks:
      - ecommerce-network

  # Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: ecommerce-zookeeper
    restart: always
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - ecommerce-network

  # Kafka
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: ecommerce-kafka
    restart: always
    depends_on:
      - zookeeper
    ports:
      - "9093:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_LOG_RETENTION_HOURS: 168
    networks:
      - ecommerce-network

  # Kafdrop - Kafka Web UI
  kafdrop:
    image: obsidiandynamics/kafdrop:latest
    container_name: ecommerce-kafdrop
    restart: always
    depends_on:
      - kafka
    ports:
      - "9001:9000"
    environment:
      KAFKA_BROKERCONNECT: kafka:29092
      JVM_OPTS: "-Xms32M -Xmx64M"
    networks:
      - ecommerce-network

  # NestJS Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ecommerce-api
    restart: always
    ports:
      - "${NODE_PORT}:3000"
    environment:
      NODE_PORT: ${NODE_PORT}
      APPLICATION_NAME: ${APPLICATION_NAME}
      
      # Database - uses service name for Docker networking
      DATABASE_HOST: mysql
      DATABASE_PORT: ${DATABASE_PORT}
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_DB: ${DATABASE_DB}
      
      # Kafka - uses service name for Docker networking
      KAFKA_BROKER_URL: kafka:29092
      KAFKA_GROUP_ID: ${KAFKA_GROUP_ID}
      
      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      
      # Kafka Topics
      SEND_EMAIL_REQUEST_TOPIC: ${SEND_EMAIL_REQUEST_TOPIC}
      
      # Redis - uses service name for Docker networking
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      
      # Queue
      QUEUE_NAME: ${QUEUE_NAME}
      QUEUE_RETRIES: ${QUEUE_RETRIES}
      QUEUE_DELAY: ${QUEUE_DELAY}
      QUEUE_MAX_REQUESTS: ${QUEUE_MAX_REQUESTS}
      QUEUE_DURATION: ${QUEUE_DURATION}
      QUEUE_CONCURRENCY: ${QUEUE_CONCURRENCY}
      
      # Admin User
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    depends_on:
      - mysql
      - redis
      - kafka
    networks:
      - ecommerce-network

networks:
  ecommerce-network:
    driver: bridge

volumes:
  mysql-data: